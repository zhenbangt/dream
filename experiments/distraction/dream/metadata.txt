Commit: 26a3d5d0843350d6e5e07262d40c9c7649568e1f

embed.py
=======================================================
lhs: 100644 | e2bb3f46c2e17a4c0aea79b686270888eb9e6dd5
rhs: 100644 | 77ad0add7840a6c83b3815c8533b1b6da7700a27
---@@ -9,7 +9,7 @@ from envs import grid
 from torch import distributions as td
 from torch import nn
 from torch.nn import functional as F
-
+from pytorch_metric_learning import losses
 
 class Embedder(abc.ABC, nn.Module):
     """Defines the embedding of an object in the forward method.
@@ -120,6 +120,9 @@ class TrajectoryEmbedder(Embedder, relabel.RewardLabeler):
         self._transition_output_layer = nn.Linear(128, embed_dim)
         self._penalty = penalty
         self._use_ids = True
+        self._contra_loss_func = losses.ContrastiveLoss(
+            pos_margin=0, neg_margin=10
+        )  # seems like neg_margin needs fine-tuning
 
     def use_ids(self, use):
         self._use_ids = use
@@ -207,6 +210,9 @@ class TrajectoryEmbedder(Embedder, relabel.RewardLabeler):
         Returns:
           losses (dict(str: torch.FloatTensor)): see forward().
         """
+        ids_true = torch.tensor(
+            [traj[0].state.env_id for traj in trajectories]
+        )  # used for computing contrastive loss
         del trajectories
 
         transition_context_loss = (
@@ -215,10 +221,14 @@ class TrajectoryEmbedder(Embedder, relabel.RewardLabeler):
         transition_context_loss = (
             transition_context_loss * mask).sum() / mask.sum()
 
+
         cutoff = torch.ones(id_contexts.shape[0]) * 10
+
+        id_contexts_contra_loss = self._contra_loss_func(id_contexts, ids_true.squeeze(1))
         losses = {
             "transition_context_loss": transition_context_loss,
-            "id_context_loss": torch.max((id_contexts ** 2).sum(-1), cutoff).mean()
+            "id_context_loss": torch.max((id_contexts ** 2).sum(-1), cutoff).mean(),
+            "id_context_contrastive_loss": id_contexts_contra_loss
         }
         return losses
 

---

Split: (array([[  0],
       [ 11],
       [ 22],
       [ 33],
       [ 44],
       [ 55],
       [ 66],
       [ 77],
       [ 88],
       [ 99],
       [110],
       [121],
       [132],
       [143],
       [154],
       [165],
       [176],
       [187],
       [198],
       [209],
       [220],
       [231],
       [242],
       [253],
       [264],
       [275],
       [286],
       [297],
       [308],
       [319],
       [330],
       [341],
       [352],
       [363],
       [374],
       [385],
       [396],
       [407],
       [418],
       [429],
       [440],
       [451],
       [462],
       [473],
       [484],
       [495],
       [506],
       [517],
       [528],
       [539],
       [550],
       [561],
       [572]]), array([[  1],
       [  2],
       [  3],
       [  4],
       [  5],
       [  6],
       [  7],
       [  8],
       [  9],
       [ 10],
       [ 12],
       [ 13],
       [ 14],
       [ 15],
       [ 16],
       [ 17],
       [ 18],
       [ 19],
       [ 20],
       [ 21],
       [ 23],
       [ 24],
       [ 25],
       [ 26],
       [ 27],
       [ 28],
       [ 29],
       [ 30],
       [ 31],
       [ 32],
       [ 34],
       [ 35],
       [ 36],
       [ 37],
       [ 38],
       [ 39],
       [ 40],
       [ 41],
       [ 42],
       [ 43],
       [ 45],
       [ 46],
       [ 47],
       [ 48],
       [ 49],
       [ 50],
       [ 51],
       [ 52],
       [ 53],
       [ 54],
       [ 56],
       [ 57],
       [ 58],
       [ 59],
       [ 60],
       [ 61],
       [ 62],
       [ 63],
       [ 64],
       [ 65],
       [ 67],
       [ 68],
       [ 69],
       [ 70],
       [ 71],
       [ 72],
       [ 73],
       [ 74],
       [ 75],
       [ 76],
       [ 78],
       [ 79],
       [ 80],
       [ 81],
       [ 82],
       [ 83],
       [ 84],
       [ 85],
       [ 86],
       [ 87],
       [ 89],
       [ 90],
       [ 91],
       [ 92],
       [ 93],
       [ 94],
       [ 95],
       [ 96],
       [ 97],
       [ 98],
       [100],
       [101],
       [102],
       [103],
       [104],
       [105],
       [106],
       [107],
       [108],
       [109],
       [111],
       [112],
       [113],
       [114],
       [115],
       [116],
       [117],
       [118],
       [119],
       [120],
       [122],
       [123],
       [124],
       [125],
       [126],
       [127],
       [128],
       [129],
       [130],
       [131],
       [133],
       [134],
       [135],
       [136],
       [137],
       [138],
       [139],
       [140],
       [141],
       [142],
       [144],
       [145],
       [146],
       [147],
       [148],
       [149],
       [150],
       [151],
       [152],
       [153],
       [155],
       [156],
       [157],
       [158],
       [159],
       [160],
       [161],
       [162],
       [163],
       [164],
       [166],
       [167],
       [168],
       [169],
       [170],
       [171],
       [172],
       [173],
       [174],
       [175],
       [177],
       [178],
       [179],
       [180],
       [181],
       [182],
       [183],
       [184],
       [185],
       [186],
       [188],
       [189],
       [190],
       [191],
       [192],
       [193],
       [194],
       [195],
       [196],
       [197],
       [199],
       [200],
       [201],
       [202],
       [203],
       [204],
       [205],
       [206],
       [207],
       [208],
       [210],
       [211],
       [212],
       [213],
       [214],
       [215],
       [216],
       [217],
       [218],
       [219],
       [221],
       [222],
       [223],
       [224],
       [225],
       [226],
       [227],
       [228],
       [229],
       [230],
       [232],
       [233],
       [234],
       [235],
       [236],
       [237],
       [238],
       [239],
       [240],
       [241],
       [243],
       [244],
       [245],
       [246],
       [247],
       [248],
       [249],
       [250],
       [251],
       [252],
       [254],
       [255],
       [256],
       [257],
       [258],
       [259],
       [260],
       [261],
       [262],
       [263],
       [265],
       [266],
       [267],
       [268],
       [269],
       [270],
       [271],
       [272],
       [273],
       [274],
       [276],
       [277],
       [278],
       [279],
       [280],
       [281],
       [282],
       [283],
       [284],
       [285],
       [287],
       [288],
       [289],
       [290],
       [291],
       [292],
       [293],
       [294],
       [295],
       [296],
       [298],
       [299],
       [300],
       [301],
       [302],
       [303],
       [304],
       [305],
       [306],
       [307],
       [309],
       [310],
       [311],
       [312],
       [313],
       [314],
       [315],
       [316],
       [317],
       [318],
       [320],
       [321],
       [322],
       [323],
       [324],
       [325],
       [326],
       [327],
       [328],
       [329],
       [331],
       [332],
       [333],
       [334],
       [335],
       [336],
       [337],
       [338],
       [339],
       [340],
       [342],
       [343],
       [344],
       [345],
       [346],
       [347],
       [348],
       [349],
       [350],
       [351],
       [353],
       [354],
       [355],
       [356],
       [357],
       [358],
       [359],
       [360],
       [361],
       [362],
       [364],
       [365],
       [366],
       [367],
       [368],
       [369],
       [370],
       [371],
       [372],
       [373],
       [375],
       [376],
       [377],
       [378],
       [379],
       [380],
       [381],
       [382],
       [383],
       [384],
       [386],
       [387],
       [388],
       [389],
       [390],
       [391],
       [392],
       [393],
       [394],
       [395],
       [397],
       [398],
       [399],
       [400],
       [401],
       [402],
       [403],
       [404],
       [405],
       [406],
       [408],
       [409],
       [410],
       [411],
       [412],
       [413],
       [414],
       [415],
       [416],
       [417],
       [419],
       [420],
       [421],
       [422],
       [423],
       [424],
       [425],
       [426],
       [427],
       [428],
       [430],
       [431],
       [432],
       [433],
       [434],
       [435],
       [436],
       [437],
       [438],
       [439],
       [441],
       [442],
       [443],
       [444],
       [445],
       [446],
       [447],
       [448],
       [449],
       [450],
       [452],
       [453],
       [454],
       [455],
       [456],
       [457],
       [458],
       [459],
       [460],
       [461],
       [463],
       [464],
       [465],
       [466],
       [467],
       [468],
       [469],
       [470],
       [471],
       [472],
       [474],
       [475],
       [476],
       [477],
       [478],
       [479],
       [480],
       [481],
       [482],
       [483],
       [485],
       [486],
       [487],
       [488],
       [489],
       [490],
       [491],
       [492],
       [493],
       [494],
       [496],
       [497],
       [498],
       [499],
       [500],
       [501],
       [502],
       [503],
       [504],
       [505],
       [507],
       [508],
       [509],
       [510],
       [511],
       [512],
       [513],
       [514],
       [515],
       [516],
       [518],
       [519],
       [520],
       [521],
       [522],
       [523],
       [524],
       [525],
       [526],
       [527],
       [529],
       [530],
       [531],
       [532],
       [533],
       [534],
       [535],
       [536],
       [537],
       [538],
       [540],
       [541],
       [542],
       [543],
       [544],
       [545],
       [546],
       [547],
       [548],
       [549],
       [551],
       [552],
       [553],
       [554],
       [555],
       [556],
       [557],
       [558],
       [559],
       [560],
       [562],
       [563],
       [564],
       [565],
       [566],
       [567],
       [568],
       [569],
       [570],
       [571],
       [573],
       [574],
       [575]]))
